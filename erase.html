<meta charset='utf-8'>
<script src='http://code.jquery.com/jquery-latest.js'></script>
<script src='multitouch.js'></script>
<script src='bezier.js'></script>
<script src='polymath.js'></script>
<script>
var W,H;
var g,canvas;
var bezierD=2;

var objects=[];


function DrawTool(touch){
  touch.move=function(){
  }
  touch.update=function(point){
    renderLine(touch.points);
    if(dotFlag)renderDot(touch.points);
  }
  touch.end=function(){
    objects.push(BezierConverter.convert(this.points,bezierD));
  }
}

function MoveTool(touch){
  var r=32;
  var mobjs=[];
  var x=touch.x;
  var y=touch.y;
  for(var i=0;i<objects.length;i++){
    if(bezierIntersect(objects[i],x,y,r)){
      mobjs.push(objects[i]);
    }
  }
  touch.move=function(point){
    var dx=point.x-x;
    var dy=point.y-y;
    for(var i=0;i<mobjs.length;i++){
      var bezier=mobjs[i];
      for(var j=0;j<bezier.length;j++){
        bezier[j].x+=dx;
        bezier[j].y+=dy;
      }
    }
    x=point.x;
    y=point.y;
  }
  touch.update=function(point){
    g.globalAlpha=0.1;
    g.beginPath();
    g.arc(point.x,point.y,r,0,2*Math.PI,true);
    g.stroke();
    g.globalAlpha=1;
  }
  touch.end=function(){

  }
}


function EraseTool(touch){
  var r=32;
  function erase(x,y){
    var out=[];
    for(var i=0;i<objects.length;i++){
      var lefts=bezierEraseWith(objects[i],new CircleEraser(x,y,r));
      out.push.apply(out,lefts);
    }
    objects=out;
  }
  erase(touch.x,touch.y);
  touch.move=function(point){
    var prev=touch.points[touch.points.length-2];
    erase(point.x,point.y);
    var dx=point.x-prev.x;
    var dy=point.y-prev.y;
    var out=[];
    for(var i=0;i<objects.length;i++){
      var lefts=bezierEraseWith(objects[i],new RectEraser(prev.x,prev.y,dx,dy,2*r));
      out.push.apply(out,lefts);
    }
    objects=out;
  }
  touch.update=function(point){
    g.globalAlpha=0.1;
    g.beginPath();
    g.arc(point.x,point.y,r,0,2*Math.PI,true);
    g.stroke();
    g.globalAlpha=1;
  }
}
var Tool=DrawTool;
var dotFlag=true;
$(function(){
  canvas=$('canvas').get(0)
  W=canvas.width;
  H=canvas.height;
  g=canvas.getContext('2d');
  $('canvas').multitouch(function(touch){
    new Tool(touch);
  },render);

  var N=200;
  var noise=2;
  var line=[];for(var i=0;i<=N;i++){
    t=i/N;
    t=t+Math.sin(20*t)/40;
    line.push({x:200+100*(1+t)*Math.cos(2*Math.PI*t)+noise*Math.random(),y:200+100*(1+t)*Math.sin(2*Math.PI*t)+noise*Math.random()})
  }
  objects.push(BezierConverter.convert(line,bezierD));
  render();
});

function render(){
  g.clearRect(0,0,W,H);
  g.fillStyle="cyan"
  g.strokeStyle='black'
  g.lineJoin="round"
  g.lineWidth=2
  g.lineCap='round'
  for(var i=0;i<objects.length;i++){
    renderLine(objects[i]);
    if(dotFlag)renderDot(objects[i]);
  }
}

function renderDot(points){
  g.beginPath();
  for(var i=0;i<points.length;i++){
    var p=points[i];
    g.moveTo(p.x,p.y);
    g.arc(p.x,p.y,2,0,2*Math.PI,true);
  }
  g.fill();
}
function renderLine(line){
  var p=line[0];
  g.beginPath();
  g.moveTo(p.x,p.y);
  for(var i=1;i<line.length;i++){
    var p=line[i-1]
    var q=line[i];
    var ax=p.dx*p.ln||0,ay=p.dy*p.ln||0;
    var bx=q.dx*q.lp||0,by=q.dy*q.lp||0;

    g.bezierCurveTo(p.x+ax,p.y+ay,q.x-bx,q.y-by,q.x,q.y);
  }
  g.stroke();
}

function set(mode){
  switch(mode){
    case 'draw':Tool=DrawTool;break;
    case 'move':Tool=MoveTool;break;
    case 'erase':Tool=EraseTool;break;
  }
  $('#tools').attr('class',mode);render();
}
</script>
<style>
canvas{position:absolute;left:0;top:0;background:#eee;}
#tools{position:fixed;left:10px;top:10px;height:0;}
#tools div{
  background:white;color:gray;
  display:inline-block;
  padding:4px 16px;
  margin: 0 8px;
  border-radius:4px;
  box-shadow:0 0 2px gray;
}

#tools.draw #draw, #tools.erase #erase, #tools.move #move{
  background:gray;
  color:white;
}

button, input{font-size:16px;}
</style>
<canvas style='position:absolute;left:0;top:0;background:#eee;' width=1024 height=1024></canvas>
<div id='tools' class='draw'>
  <div id='draw' onclick="set('draw')" ontouchstart="set('draw')">Draw</div>
  <div id='move' onclick="set('move')" ontouchstart="set('move')">Move</div>
  <div id='erase' onclick="set('erase')" ontouchstart="set('erase')">Erase</div>
  <input type=checkbox onchange="dotFlag=checked;render()" checked>
</div>
