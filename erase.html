<meta charset='utf-8'>
<script src='http://code.jquery.com/jquery-latest.js'></script>
<script src='multitouch.js'></script>
<script src='bezier.js'></script>
<script src='polymath.js'></script>
<script>
var W,H;
var g,canvas;
var bezierD=2;

var objects=[];

function DrawTool(touch){
  touch.move=function(){
  }
  touch.update=function(alive){
    renderLine(touch.points);
  }
  touch.end=function(){
    objects.push(BezierConverter.convert(this.points,bezierD));
  }
}

function EraseTool(touch){
  var r=32;
  function erase(x,y){
    var out=[];
    for(var i=0;i<objects.length;i++){
      var lefts=bezierErase(objects[i],x,y,r);
      out.push.apply(out,lefts);
    }
    objects=out;
  }
  erase(touch.x,touch.y);
  touch.move=function(point){
    var prev=touch.points[touch.points.length-2];
    erase(point.x,point.y);
    var dx=point.x-prev.x;
    var dy=point.y-prev.y;
    var out=[];
    for(var i=0;i<objects.length;i++){
      var lefts=bezierEraseRect(objects[i],prev.x,prev.y,dx,dy,2*r);
      out.push.apply(out,lefts);
    }
    objects=out;
  }
  touch.update=function(point){
    g.globalAlpha=0.1;
    g.beginPath();
    g.arc(point.x,point.y,r,0,2*Math.PI,true);
    g.stroke();
    g.globalAlpha=1;
  }
}
var Tool=DrawTool;
var dotFlag=true;
$(function(){
  canvas=$('canvas').get(0)
  W=canvas.width;
  H=canvas.height;
  g=canvas.getContext('2d');
  $('canvas').multitouch(function(touch){
    new Tool(touch);
  },render);

  var N=200;
  var noise=2;
  var line=[];for(var i=0;i<=N;i++){
    t=i/N;
    t=t+Math.sin(20*t)/40;
    line.push({x:200+100*(1+t)*Math.cos(2*Math.PI*t)+noise*Math.random(),y:200+100*(1+t)*Math.sin(2*Math.PI*t)+noise*Math.random()})
  }
  objects.push(BezierConverter.convert(line,bezierD));
  render();
});

function render(){
  g.clearRect(0,0,W,H);
  g.fillStyle="cyan"
  g.strokeStyle='black'
  g.lineJoin="round"
  g.lineWidth=2
  g.lineCap='round'
  for(var i=0;i<objects.length;i++){
    renderLine(objects[i]);
    if(dotFlag)renderDot(objects[i]);
  }
}

function renderDot(points){
  g.beginPath();
  for(var i=0;i<points.length;i++){
    var p=points[i];
    g.moveTo(p.x,p.y);
    g.arc(p.x,p.y,2,0,2*Math.PI,true);
  }
  g.fill();
}
function renderLine(line){
  var p=line[0];
  g.beginPath();
  g.moveTo(p.x,p.y);
  for(var i=1;i<line.length;i++){
    var p=line[i-1]
    var q=line[i];
    var ax=p.dx||0,ay=p.dy||0;
    var bx=q.dx||0,by=q.dy||0;
    var dx=q.x-p.x,dy=q.y-p.y;
    var len=Math.sqrt(dx*dx+dy*dy);
    g.bezierCurveTo(p.x+ax*len/3,p.y+ay*len/3,q.x-bx*len/3,q.y-by*len/3,q.x,q.y);
  }
  g.stroke();
}
</script>
<style>
canvas{position:absolute;left:0;top:0;background:#eee;}
#tools{position:fixed;left:10px;top:10px;height:0;}
#tools div{
  background:white;color:gray;
  display:inline-block;
  padding:4px 16px;
  margin: 0 8px;
  box-shadow:0 0 2px gray;
}

#tools.draw #draw{background:silver;}
#tools.erase #erase{background:silver;}
button, input{font-size:16px;}
</style>
<canvas style='position:absolute;left:0;top:0;background:#eee;' width=1024 height=1024></canvas>
<div id='tools' class='draw'>
  <div id='draw' onclick="Tool=DrawTool;$('#tools').attr('class','draw');render();">Draw</div>
  <div id='erase' onclick="Tool=EraseTool;$('#tools').attr('class','erase');render();">Erase</div>
  <input type=checkbox onchange="dotFlag=checked;render()" checked>
</div>
