<meta charset='utf-8'>
<script src='http://code.jquery.com/jquery-latest.js'></script>
<script src='bezier.js'></script>
<script>
var W,H;
var lines=[];
var line=null;
var g,canvas;
var renderMode=2;
var bezierD=1;
var smoothD=bezierD*2/3;

var dotFlag=true;
$(function(){
  canvas=$('canvas').get(0)
  W=canvas.width;
  H=canvas.height;
  g=canvas.getContext('2d');
  $('canvas').on('mousedown',function(e){
    line=[{x:e.pageX,y:e.pageY}];
    render();
    return false;
  })
  $(document).on('mouseup',function(e){
    if(!line)return;
    lines.push([line,BezierConverter.grad(BezierConverter.smooth(line,smoothD)),BezierConverter.convert(line,bezierD)]);
    line=null;
    render();
    return false;
  })
  $(document).on('mousemove',move=function(e){
    if(!line)return;
    line.push({x:e.pageX,y:e.pageY});
    render();
  })
  var N=200;
  var noise=2;
  line=[];for(var i=0;i<=N;i++){
    t=i/N;
    t=t+Math.sin(20*t)/40;
    line.push({x:200+100*(1+t)*Math.cos(2*Math.PI*t)+noise*Math.random(),y:200+100*(1+t)*Math.sin(2*Math.PI*t)+noise*Math.random()})
  }
  lines.push([line,BezierConverter.grad(BezierConverter.smooth(line,smoothD)),BezierConverter.convert(line,bezierD)]);
  line=null;
  render();
});

function render(){
  g.clearRect(0,0,W,H);
  g.fillStyle="cyan"
  g.strokeStyle='black'
  g.lineJoin="round"
  g.lineWidth=4
  g.lineCap='round'
  for(var i=0;i<lines.length;i++){
    renderLine(lines[i][renderMode%3]);
    if(dotFlag)renderDot(lines[i][renderMode%3]);
  }
  if(line){
    renderLine(line);
    if(dotFlag)renderDot(line);
  }
}

function renderDot(points){
  g.beginPath();
  for(var i=0;i<points.length;i++){
    var p=points[i];
    g.moveTo(p.x,p.y);
    g.arc(p.x,p.y,2,0,2*Math.PI,true);
  }
  g.fill();
}
function renderLine(line){
  var p=line[0];
  g.beginPath();
  g.moveTo(p.x,p.y);
  for(var i=1;i<line.length;i++){
    var p=line[i-1]
    var q=line[i];
    var ax=p.dx||0,ay=p.dy||0;
    var bx=q.dx||0,by=q.dy||0;
    var dx=q.x-p.x,dy=q.y-p.y;
    var len=Math.sqrt(dx*dx+dy*dy);
    g.bezierCurveTo(p.x+ax*len/3,p.y+ay*len/3,q.x-bx*len/3,q.y-by*len/3,q.x,q.y);
  }
  g.stroke();
}
function resolutionUpdate(val){
  bezierD=parseFloat(val);
  smoothD=bezierD*2/3;
  for(var i=0;i<lines.length;i++){
    var line=lines[i][0];
    lines[i][1]=BezierConverter.grad(BezierConverter.smooth(line,smoothD));
    lines[i][2]=BezierConverter.convert(line,bezierD);
  }
  render();
}
</script>
<style>
canvas{position:absolute;left:0;top:0;background:#eee;}
div{position:fixed;left:0;top:0;height:0;}
div.mode0 .button0{color:blue;}
div.mode1 .button1{color:blue;}
div.mode2 .button2{color:blue;}
.clear{margin-left:50px;}
</style>
<canvas style='position:absolute;left:0;top:0;background:#eee;' width=1024 height=1024></canvas>
<div class='mode2'>
<input type=button onclick="renderMode=0;render();$('div').attr('class','mode0')" class='button0' value='元データ'>
<input type=button onclick="renderMode=1;render();$('div').attr('class','mode1')" class='button1' value='ノイズ除去'>
<input type=button onclick="renderMode=2;render();$('div').attr('class','mode2')" class='button2' value='ベジェ'>
<input type=checkbox onchange="dotFlag=checked;render()" checked>
<input type=button onclick='lines=[];render()' class='clear' value='clear'>
<select onchange='resolutionUpdate(value)'>
<option value=1>1</option>
<option value=2>2</option>
<option value=3>3</option>
<option value=4>4</option>
<option value=5>5</option>
<option value=6>6</option>
<option value=7>7</option>
<option value=8>8</option>
</select>
</div>